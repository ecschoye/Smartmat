image: docker:latest

variables:
  DOCKER_DRIVER: overlay2
  SPRING_PROFILES_ACTIVE: dev

services:
- name: docker:dind
  command: ["dockerd-entrypoint.sh", "--privileged"]


stages:
  - build-backend
  - test
  - deploy

build-backend:
  stage: build-backend
  script:
    - cd ./backend
    - docker build -t my-backend-image -f Dockerfile-test .
    - docker save my-backend-image > my-backend-image-latest.tar

test:
  stage: test
  script:
    - docker load < my-backend-image-latest.tar
    - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock my-backend-image mvn test

deploy:
  stage: deploy
  script:
    - docker load < my-frontend-image-latest.tar
    - docker load < my-backend-image-latest.tar
    - docker-compose up -d
